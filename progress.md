Original prompt: Build a classic pokemon first town demo based on this current repo using the Develop Web Game skill

## 2026-02-11
- Initialized progress tracking for this turn.
- Confirmed `develop-web-game` skill instructions and local Playwright client/action payload paths.
- Context gathered: runtime movement/dialogue/warp system, current maps, tile legend, and UI flow.

### TODO
- Rebuild first-town map content and add a lab interior map.
- Expand dialogue scripts to feel like a classic first-town intro.
- Add `window.render_game_to_text` and deterministic `window.advanceTime(ms)` in the game view.
- Add fullscreen toggle (`f`) and keep existing controls stable.
- Run Playwright client, inspect screenshots + state JSON + console errors, and iterate.
- Rebuilt map content for a more classic first-town flow:
  - Updated `player-house` layout and swapped intro NPC to Mom.
  - Reworked `starter-town` as Willowbrook Town with signs, locked houses, NPCs, and lab entrance.
  - Added new `rowan-lab` map with professor/rival NPCs and interaction points.
- Updated map registry and dialogue scripts to support the new town arc.
- Added runtime/UI support for the develop-web-game test loop:
  - `RuntimeSnapshot` now includes a live objective.
  - Implemented `runtime.renderGameToText()` with map/player/dialogue/NPC/interaction state.
  - Added deterministic stepping support via `window.advanceTime(ms)` in `GameView`.
  - Added global `window.render_game_to_text` bridge in `GameView`.
  - Added fullscreen toggle on `f` with `Esc` fullscreen exit handling.
- Updated controls modal and HUD objective banner for clearer gameplay guidance.
- Enabled automation-friendly startup by pre-filling the trainer name with `Player` on the New Game screen.
- First Playwright run exposed a runtime crash: `rowan-lab` had one row with width 17 instead of 18.
- Fixed malformed row in `src/game/data/maps/rowanLab.ts`.
- Installed `playwright` and Chromium browser for automated validation runs.
- Verified automated startup into gameplay works and `state-0.json` is produced with `render_game_to_text` output.
- Verified objective progression updates after Mom dialogue (`flags: ["talked_to_mom"]`).

### Remaining TODOs / Next Agent Suggestions
- Improve Playwright action choreography to reliably traverse house -> town -> lab in a single automated run.
- Add dedicated tests or scripted scenarios for:
  - Door warp from `player-house` to `starter-town`.
  - Lab warp + professor dialogue + starter table flag progression.
  - Objective transitions through all early-game states.

## 2026-02-12
- Refreshed intro narrative on request:
  - Home NPC changed from Mom to Brother (`Eli`).
  - `rowan-lab` replaced with `rival-house` (`Kira House`) as the starter location.
  - Starter-giver changed from professor to rival parent (`Aunt Mara`).
- Updated warps/interactions/dialogue/objective text and flags to match the new story arc.
- Renamed map file to `src/game/data/maps/rivalHouse.ts` and updated map registry + map docs.
- Validation:
  - `npm run build` passed.
  - Playwright run captured screenshot + `state-0.json` confirming `Eli` dialogue and updated objective text.

## 2026-02-12 (Admin Tool)
- Original prompt continuation: build an admin tool with a map editor module for creating/editing maps, including warp setup and tileset-driven design.
- Scanned current app architecture and discovered local `example_assets` packs (tileset/sprites/UI) to wire into editor UX.
- Implemented admin shell with module navigation (`Map Editor`, placeholder modules for future tools).
- Added full `MapEditorTool` with:
  - Existing map load + blank map creation + map resize.
  - Tile painting tools (paint/erase/fill/eyedropper) with zoom.
  - Tileset URL/file loading and per-tile atlas index mapping.
  - Warp CRUD with click-placement (`from`/`to`) and edge helper placement.
  - NPC and interaction JSON editing.
  - Export to JSON and TypeScript (`createMap(...)`) plus import from JSON.
  - Basic map validation warnings (bounds and unknown warp target IDs).
- Added admin entrypoint from title screen via `Admin Tools` button.
- Added admin-specific documentation at `src/admin/README_ADMIN_MAP_EDITOR.md`.
- Validation:
  - `npm run build` passed.
  - Playwright visual sanity checks rendered Admin Map Editor screen with no emitted error logs.
- Refactored admin tools to a separate app entrypoint in the same repo:
  - Added `admin.html` + `src/admin/main.tsx` + `src/admin/AdminApp.tsx`.
  - Updated Vite multi-page build inputs for game + admin outputs.
  - Game title now links to `/admin.html` instead of embedding admin in game state.
- Updated admin UI shell for scrollability:
  - Full-height admin screen with independent scrolling regions.
  - Scrollable module content, left/right editor columns, tileset grid, saved paint list, and map canvas.
- Implemented advanced tileset workflow in Map Editor:
  - Default tileset loads and renders as a grid based on user-defined tile width/height.
  - Manual selection of atlas cells from grid.
  - Auto mode to generate default paint tiles.
  - Manual mode to save selected atlas cells into paint tools with custom name + tile code.
  - Saved paint tile management (rename/reassign/remove + remove selected button).
- Updated admin docs to reflect separate app + new tileset/palette workflow.
- Validation:
  - `npm run build` passed with both `dist/index.html` and `dist/admin.html` outputs.
  - Playwright checks against `/admin.html` rendered the standalone admin app with no emitted console error artifacts.
- Updated manual tileset-picker save flow so tile codes are always auto-generated from an available single-character pool and stored on each saved paint tile entry (`SavedPaintTile.code`).
- Code generation now avoids collisions with existing saved paint tile codes and codes already used on the active map, enabling tile IDs beyond the built-in base set.
- Added map warning for custom tile codes not present in `src/game/world/tiles.ts`, so exported maps using generated codes flag required runtime tile-definition follow-up.
- Expanded admin map tile picker to support rectangle selection via click-drag on the atlas grid.
- Saved paint tiles now support multi-cell stamp definitions (`width`, `height`, `cells[]`) instead of only single atlas indices.
- Painting now applies full stamp footprints to the map canvas (all cell offsets in the saved tile), enabling multi-tile structures (e.g., building chunks).
- Admin startup now initializes blank by default:
  - no map loaded,
  - no tileset loaded,
  - empty tile pixel width/height fields,
  - empty JSON editors,
  - no in-memory saved paint tiles.
- Added explicit `Load Saved Tiles` action and IndexedDB persistence for saved paint tiles in `src/admin/indexedDbStore.ts`.
- New/updated/removed saved paint tiles now persist to IndexedDB for future sessions.
- Added migration-compatible tile sanitization so older single-cell saved tile shapes can still be loaded and normalized.
- Updated paint tile and saved tile UI previews to render multi-cell stamps and show stamp dimensions.
- Added map-canvas empty state when no map is loaded.
- Validation:
  - `npm run build` passed after refactor.
  - Playwright screenshot check on `/admin.html` confirms blank-start admin state and no emitted console-error artifacts (`output/admin-map-editor/shot-0.png`).
  - Additional Playwright run confirmed rectangle save metadata as multi-cell (`11x1 | 11 codes`).
- Added direct map file saving from admin via new local API endpoint: `POST /api/admin/maps/save` (Vite plugin middleware in `vite.config.ts`).
- Map save behavior:
  - If editing a loaded existing map, save writes back to that map's original file.
  - If creating/importing a new map, save creates/updates `src/game/data/maps/<derivedFileName>.ts` using existing map format (`createMap({...})` export).
  - Regenerates `src/game/data/maps/index.ts` imports and `WORLD_MAPS` registry order.
- Added bottom panel in Map Editor: `Save To Project` with `Save Map File + Tile IDs` action.
- Added custom tile runtime sync on save:
  - Save operation now writes `src/game/world/customTiles.ts` from saved paint tile cell metadata + map tile usage.
  - Introduced runtime merge of base + custom tile definitions in `src/game/world/tiles.ts`.
  - Runtime now optionally renders custom tiles from a configured tileset atlas (`CUSTOM_TILESET_CONFIG`) and falls back to color rendering if unavailable.
- Relaxed tile code typing to support custom single-character IDs across world types/runtime path.
- Build validation: `npm run build` passed.
- Playwright visual sanity check on `/admin.html` confirms new bottom save panel is visible (`output/admin-map-save/shot-0.png`).
- Added right-click blank-paint behavior in map canvas editing:
  - Right mouse click on a map cell now writes blank tile code `.`.
  - Context menu is suppressed for map-cell right-clicks.
- Added multi-cell stamp hover preview shadow:
  - When selected paint tile is larger than 1x1, hovering map cells shows an opaque placement shadow for all affected cells.
- Added base blank tile definition in runtime tile registry (`BLANK_TILE_CODE = '.'`) and renderer/physics handling:
  - Blank tiles are not rendered in runtime draw pass.
  - Blank tiles are non-walkable.
- Updated save pipeline base tile-code set to treat `.` as built-in (not custom-generated).
- Validation: `npm run build` passed.
- Implemented layered map editing + rotated painting in admin map editor.
- Added new paint tool `Paint Rotated`:
  - randomly rotates placed tiles by 0/90/180/270 degrees,
  - supports multi-cell stamp tiles,
  - preserves right-click blank erase behavior.
- Refactored admin editable map model from single `tiles[]` to `layers[]` with per-layer:
  - `tiles` rows,
  - `rotations` rows (0-3),
  - `visible` and `collision` flags,
  - layer id/name metadata.
- Added layer management UI in Active Map panel:
  - select active layer,
  - add/remove layers,
  - rename layer id/name,
  - toggle visibility + collision.
- Updated map canvas rendering in admin to draw stacked visible layers and highlight active layer content.
- Updated editor JSON/TS export and import to support `layers` while preserving legacy single-layer `tiles` output when possible.
- Updated save API (`vite.config.ts`) to validate and persist layered maps:
  - accepts `map.layers` payload,
  - writes `layers` to map files when needed,
  - writes legacy `tiles` format for simple base-only maps,
  - scans tile codes across all layers for custom tile sync.
- Updated runtime map drawing + collision handling for layers/rotations:
  - renders all visible layers in order,
  - applies per-cell quarter-turn atlas rotation during draw,
  - collision checks only layers marked `collision`.
- CSS updates for stacked tile rendering and active layer emphasis in map cells.

Validation
- `npm run build` passes after layer/rotation refactor.
- Playwright sanity screenshot confirms admin loads with new `Paint Rotated` control.
- Gameplay runtime screenshot sanity captured; no build/runtime crash observed.

Follow-up suggestions
- Add explicit rotation visualization in paint-tile palette (tiny rotation badge) when using `Paint Rotated` hover.
- Add dedicated Playwright action scripts for full admin flows (load map, add layer, paint, save, reload).
- Add map migration helper command to convert legacy `tiles` maps into a two-layer starter format automatically.
- Addressed custom tile warning noise in editor:
  - map validation now treats tile codes present in saved paint tiles as known custom codes,
  - warning text now points to `Save Map File + Tile IDs` for runtime sync.
- Updated manual atlas save flow to immediately persist the new saved tile list (including generated codes) to IndexedDB in one explicit update path.
- Build validation: `npm run build` passed.
- Added per-cell edge collision editing and runtime support.
- World map schema updates:
  - `WorldMapLayerInput.collisionEdges?: string[]`
  - `WorldMapLayer.collisionEdges: number[][]`
- Map parser (`createMap`) now reads hex edge masks (`0-f`) per cell with defaults to `0`.
- Admin editor data model now tracks `collisionEdges` per layer.
- Admin map editor new paint tool: `Collision Edges`:
  - edge side toggles (`Top`, `Right`, `Bottom`, `Left`),
  - add/remove mode,
  - drag-paint support,
  - right-click clears collision edges on hovered cell for active layer,
  - visible edge overlay on map cells.
- Runtime movement now respects edge collisions:
  - blocks movement if source tile has blocking edge in move direction,
  - blocks movement if target tile has opposite-side blocking edge.
- Save/load pipeline updates:
  - map import/export JSON/TS includes `collisionEdges` when non-zero,
  - Vite save middleware validates and persists `collisionEdges` for layer maps.
- Style updates for collision edge overlays in editor canvas.
- Validation: `npm run build` passed after collision-edge integration.
- Addressed reported in-game vertical line artifacts by stabilizing camera-to-screen tile placement math in runtime render:
  - use rounded camera pixel offsets once per frame,
  - derive tile screen positions from integer tile pixel positions minus camera pixel offset.
- Added map-canvas axes in admin editor for coordinate debugging:
  - X-axis labels across top (0-based),
  - Y-axis labels down left (0-based),
  - top-left corner marker `Y\\X`.
- Validation:
  - `npm run build` passed after runtime and editor axis changes.
- Implemented NPC sprite + movement support across editor/runtime.
- World NPC schema now supports optional:
  - inline dialogue (`dialogueLines`, `dialogueSpeaker`, `dialogueSetFlag`),
  - movement (`type: static|loop|random`, `pattern`, `stepIntervalMs`),
  - sprite config (`url`, frame size, per-direction facing frames, optional walking frame sequences).
- Runtime NPC updates:
  - NPCs now use runtime state for position/facing/movement and can wander (`random`) or follow loop patterns.
  - Added sprite-sheet rendering for NPCs with directional idle/walk animation; falls back to block actor draw if sprite missing/unloaded.
  - Player collision now checks live NPC runtime positions.
  - Interact checks now target runtime NPC positions.
- Admin map editor updates for NPC workflow:
  - Added paint tools: `NPC Paint`, `NPC Erase`.
  - Added NPC template builder panel with fields for name/color/dialogue/movement.
  - Added NPC spritesheet loader (URL/file), frame grid preview, and assignment workflow for up/down/left/right idle + optional walk frames.
  - Saved NPC templates now persist via IndexedDB (`map-editor-npc-templates-v1`) and can be reloaded.
  - Painting places template-derived NPC instances on map cells; erasing removes NPC at cell.
  - Map canvas now overlays an NPC badge per occupied NPC cell for quick visual placement feedback.
- Validation:
  - `npm run build` passed.
  - Playwright admin sanity screenshot captured after changes (`output/admin-npc-painter/shot-0.png`).

Follow-up suggestions
- Add direct NPC list table editor (click NPC badge to edit/delete selected NPC instance) to avoid JSON edits for per-instance tweaks.
- Add patrol bounds mode (rectangle) for random movement so NPCs stay in local zones.
- Add optional sprite preview in NPC template list cards.
- Refactored NPC authoring model in admin to support reusable `sprite library` + `character library` split:
  - Character entries now store name/dialogue/movement/(future) battle team ids and reference a sprite by id.
  - Sprite entries store sheet URL, frame size, and directional idle/walk frame assignments.
- Added default NPC catalog in `src/game/world/npcCatalog.ts`:
  - default sprite `teen-boy` uses 4x4 row mapping at 32x32 (`Down`, `Left`, `Right`, `Up`).
  - default character `Eli` references `teen-boy`.
- Updated map NPC paint flow:
  - NPC paint now places selected character template and resolves reusable sprite by `spriteId`.
  - NPC erase unchanged (removes instance at clicked cell).
- Added user-requested 4x4 animation helper:
  - `Auto Fill 4x4 D/L/R/U` button for sprite frame assignments.
  - manual frame assignment by clicking sheet cells per selected direction + idle/walk mode remains.
- Added future-facing NPC data support in world types:
  - `battleTeamIds?: string[]` on `NpcDefinition`.
- Runtime updates:
  - player now renders from dedicated sprite config (`src/game/world/playerSprite.ts`) with idle/walk animation support.
  - fallback to old block actor draw remains if sprite image cannot load.
- Added standalone Player Sprite admin module:
  - new nav tab between Map Editor and Critters.
  - full sheet loader + frame assignment + 4x4 preset for player sprite.
  - save action writes directly to `src/game/world/playerSprite.ts` via new API route.
- Added new admin API endpoint in Vite plugin:
  - `POST /api/admin/player-sprite/save`.
- Map update:
  - seeded Eli (`playerHouse`) with explicit teen-boy sprite config to match new desired default behavior.
- Validation:
  - `npm run build` passed.
  - Admin screenshots captured for map editor + player sprite tab:
    - `output/admin-npc-character-split/shot-0.png`
    - `output/admin-player-sprite-tab/shot-0.png`

Follow-up suggestions
- Add in-UI “Edit Existing” for sprite/character library items (currently flow is save new + remove old).
- Add project-file persistence for NPC sprite/character catalogs (currently IndexedDB + defaults; map files retain resolved sprite config on placed NPCs).
- Add visual row labels directly over sprite grid (`Row 0: Down`, etc.) for faster onboarding.
## 2026-02-12 (White page fix)
- Investigated reported white screen by running Playwright checks on game and admin routes.
- Root cause: map parse crash on unknown tile code during startup:
  - `Error: Map player-house layer base uses unknown tile code: `
- Cause details:
  - `src/game/data/maps/playerHouse.ts` referenced custom tile IDs not currently present in `src/game/world/customTiles.ts`.
  - `createMap` previously threw on first unknown tile code, causing app boot failure (white page).
- Fix implemented:
  - Updated `src/game/world/mapBuilder.ts` to fail-soft on unknown tile codes:
    - unknown tile codes are replaced with `FALLBACK_TILE_CODE` at parse time,
    - warning is logged with the missing code list.
  - This prevents complete app crash/white screen while preserving map loadability.
- Validation:
  - `npm run build` passed.
  - Playwright checks for `/` and `/admin.html` now render normally with no `errors-0.json` emitted.

## 2026-02-13 (Admin overhaul: routed tabs + multi-window map workspace)
- Refactored admin navigation from in-page module toggles to route-style tabs under `/admin/<section>`:
  - `/admin/maps`
  - `/admin/tiles`
  - `/admin/npcs`
  - `/admin/player-sprite`
  - `/admin/critters`
  - `/admin/encounters`
- Added path parsing + history navigation in `src/admin/AdminView.tsx`, and kept `Critters` + `Encounters` placeholder tabs anchored at bottom of the nav.
- Added `src/admin/MapWorkspaceTool.tsx`:
  - supports multiple concurrent map editor windows,
  - each window has independent map editor state,
  - includes add/remove window and rename window controls.
- Extended `MapEditorTool` with section modes and embedded mode:
  - `section="map"`: map-focused workflow for map windows,
  - `section="tiles"`: dedicated tile library tooling,
  - `section="npcs"`: dedicated NPC studio tooling,
  - `embedded`: compact mode for map workspace cards.
- Map-focused mode now auto-loads saved tiles + NPC catalog for painting workflows and adds quick refresh controls in paint tools.
- Split visibility of large panels by section mode so UI is less cramped and each world-building concern can be used independently.
- Reset local admin catalog key versions to intentionally clear previous saved tile/NPC local data:
  - `map-editor-saved-paint-tiles-v3`
  - `map-editor-npc-sprite-library-v2`
  - `map-editor-npc-character-library-v2`
- Added `Clear NPC Catalog` action in NPC studio mode.
- Updated game title screen admin launch path from `/admin.html` to `/admin/maps`.
- Updated Vite middleware to rewrite `/admin`, `/admin.html`, and `/admin/<section>` requests to `/admin.html` in dev and preview servers so route-style paths work.
- CSS updates:
  - nav bottom spacer support,
  - embedded map editor status row,
  - single-column section layout mode,
  - responsive multi-window map workspace styles.

Validation
- `npm run build` passed.
- Playwright smoke checks (with screenshot capture, no error artifacts emitted):
  - `output/admin-overhaul-maps/shot-0.png`
  - `output/admin-overhaul-tiles/shot-0.png`
  - `output/admin-overhaul-npcs/shot-0.png`
  - `output/admin-overhaul-maps-multi/shot-0.png` (verifies "Add Map Window" flow)
  - `output/admin-overhaul-player-sprite/shot-0.png`

Follow-up suggestions
- Split map editor internals into smaller files/hooks (`useMapEditorState`, panel components) to reduce `MapEditorTool.tsx` size and improve maintainability.
- Add map-window persistence (restore open windows + labels + per-window route state) to IndexedDB.
- Add lightweight tab-level e2e action payloads to automate create/edit/save flows for Tiles, NPC Studio, and multi-window map workflows.

## 2026-02-13 (Follow-up: auto-apply uploaded sheets + more form space)
- Updated file upload behavior to auto-apply object URLs immediately after selecting a file:
  - `src/admin/MapEditorTool.tsx` tileset file picker now sets both `tilesetUrlInput` and `tilesetUrl`.
  - `src/admin/MapEditorTool.tsx` NPC spritesheet file picker now sets both `npcSpriteUrlInput` and `npcSpriteUrl`.
  - `src/admin/PlayerSpriteTool.tsx` player spritesheet file picker now sets both `spriteUrlInput` and `spriteUrl`.
- Updated status messages to reflect immediate apply behavior (`Loaded and applied ...`).
- Expanded form container/layout space for admin tabs/windows:
  - `src/styles.css` map workspace windows now use larger min width (`minmax(980px, 1fr)`) to reduce cramped forms.
  - Added `min-width: 0` safety on map windows/panels for proper overflow behavior.
  - Tuned embedded map editor column distribution for better form+tool space in map windows.

Validation
- `npm run build` passed.
- Playwright screenshot sanity checks:
  - `output/admin-form-space-maps/shot-0.png`
  - `output/admin-form-space-tiles/shot-0.png`
  - `output/admin-form-space-npcs/shot-0.png`

## 2026-02-13 (DB/auth foundation + runtime/admin data sync)
- Added backend database/auth support in `vite.config.ts` using `DB_CONNECTION_STRING` and `pg` + `bcryptjs`.
- Added schema initialization for:
  - `app_users`, `app_sessions`
  - `user_saves`
  - `world_maps`, `tile_libraries`, `npc_libraries`, `player_sprite_configs`, `critter_libraries`
- Added auth endpoints:
  - `POST /api/auth/signup`
  - `POST /api/auth/login`
  - `GET /api/auth/session`
  - `POST /api/auth/logout`
- Added game/save/content endpoints:
  - `GET/POST /api/game/save`
  - `POST /api/game/reset` (password required)
  - `GET /api/content/bootstrap`
- Added admin CRUD endpoints:
  - maps: `GET /api/admin/maps/list`, `POST /api/admin/maps/save`
  - tiles: `GET /api/admin/tiles/list`, `POST /api/admin/tiles/save`
  - npc catalogs: `GET /api/admin/npc/list`, `POST /api/admin/npc/save`
  - player sprite: `GET /api/admin/player-sprite/get`, `POST /api/admin/player-sprite/save`
  - critters: `GET /api/admin/critters/list`, `POST /api/admin/critters/save`
- Added shared auth/API helpers:
  - `src/shared/authStorage.ts`
  - `src/shared/apiClient.ts`
- Added account-first title flow (`src/ui/AuthScreen.tsx`, `src/App.tsx`) with sign in/up, logout, and start-over password confirmation.
- Added admin auth gate in `src/admin/AdminView.tsx` so admin routes require a valid session.
- Added world-content bootstrap persistence (`src/game/content/worldContentStore.ts`) and runtime hydration (`src/game/engine/runtime.ts`) so maps/custom tiles/player sprite can come from DB content.
- Updated map builder to accept injected tile definitions (`src/game/world/mapBuilder.ts`) for DB custom tile codes.
- Updated save manager to sync saves to DB and reset save via password (`src/game/saves/saveManager.ts`).
- Updated admin tools (`MapEditorTool`, `PlayerSpriteTool`) to read/write DB endpoints for maps/tiles/npcs/player sprite.

Validation
- `npm run build` passed.

## 2026-02-13 (Follow-up fix: eliminate "Checking Session" hang)
- Root cause: auth/session fetch paths could hang indefinitely on network/DB stalls, leaving admin on `Checking Session` and app on `Loading...`.
- Fixes:
  - `src/shared/apiClient.ts` now applies an 8s request timeout and converts abort/network failures into structured `{ ok: false }` API results.
  - `src/admin/AdminView.tsx` now wraps session verification in guarded try/catch and always resolves to `ok` or `blocked` state.
  - `src/App.tsx` bootstrap flow now catches auth/bootstrap failures and returns users to auth screen instead of hanging.
  - `src/game/saves/saveManager.ts` now preserves local save on transient server failures and migrates local save to DB when server save is empty.
  - `vite.config.ts` DB pool now uses connection/idle timeouts to fail faster on unreachable DB.
- Layout tuning follow-up:
  - `src/styles.css` widened single-tab forms and map-window layouts for better form space in Tiles/NPC/Map windows.

Validation
- `npm run build` passed.
- Playwright screenshots:
  - root auth page renders: `output/db-auth-root-fix/shot-0.png`
  - admin route resolves to blocked state (no perpetual checking): `output/db-auth-admin-fix/shot-0.png`

Follow-up suggestions
- Add explicit admin UI modules for Critters/Encounters wired to `/api/admin/critters/*`.
- Add a first-login migration action to seed DB maps/catalogs from existing local/static content for smoother onboarding.
- Add automated e2e auth test payloads (signup/login/logout/start-over) once DB access is available in CI/dev.
- 2026-02-13 quick tweak: `/admin/tiles` now defaults tile pixel dimensions to `16x16` by initializing `tilePixelWidthInput`/`tilePixelHeightInput` to `16` when `section === 'tiles'` in `src/admin/MapEditorTool.tsx`.
- Validation: `npm run build` passed.
- 2026-02-13 UI cleanup: removed the Tiles tab "Tile Code" field from the manual atlas save form in `src/admin/MapEditorTool.tsx`; tile codes remain auto-generated internally.
- Validation: `npm run build` passed.
- 2026-02-13 DB-only map source + spawn baseline:
  - Admin `MapEditorTool` map source now reads from DB only (removed fallback/merge with static `WORLD_MAPS`).
  - Added DB world baseline migration in `vite.config.ts`:
    - new table `user_world_state` with `map_init_version`.
    - one-time per-user reset (`WORLD_MAP_BASELINE_VERSION=1`) deletes existing `world_maps` rows and inserts only:
      - id: `spawn`
      - name: `Portlock Beach`
      - size: `11x9` blank base layer.
    - baseline enforcement runs before `/api/content/bootstrap` and `/api/admin/maps/list` responses.
  - New-game defaults now start at `spawn` center `(5,4)` in `src/game/saves/saveManager.ts`.
  - Runtime no longer uses static `WORLD_MAP_REGISTRY`; it boots from DB-hydrated content (with local `spawn` safety fallback map only).
- Validation: `npm run build` passed.
- 2026-02-13 map-window canvas visibility fix:
  - Added dedicated map-canvas panel class to `MapEditorTool` (`admin-panel--map-canvas`).
  - Added CSS minimum-height constraints so map canvas cannot collapse in map windows:
    - `.admin-panel--map-canvas { min-height: 420px; }`
    - `.admin-panel--map-canvas .map-grid-wrap { min-height: 340px; max-height: 62vh; }`
  - Goal: when a map is loaded, the full map grid section is visibly rendered in the map window instead of appearing missing/collapsed.
- Validation: `npm run build` passed.
- 2026-02-13 map editor paint transform features:
  - Added new paint tool `Fill Rotated` in `MapEditorTool`.
  - `Fill Rotated` flood-fills the clicked contiguous area and applies a 90-degree rotation progression per cell (based on cell distance from fill origin).
  - Added brush transform controls in Paint Tools:
    - `Rotate Left`
    - `Rotate Right`
    - `Mirror Horizontal`
    - `Mirror Vertical`
  - Transform controls now affect selected stamp painting/preview behavior (non-destructive to saved tile assets).
  - Standard `Fill` now honors current brush rotation quarter for placed tile rotations.
- Validation: `npm run build` passed.
- 2026-02-13 map save/game blank follow-up:
  - Added `ensureWorldBaselineForUser(auth.user.id)` to `/api/admin/maps/save` so save requests are baseline-safe even if they are the first map API call for that user.
  - Updated title-screen transitions in `App.tsx` to refresh world content from DB immediately before entering gameplay (`Continue`, `Start Game`, and after `Start Over`).
  - Goal: eliminate stale/blank map runtime caused by old cached world content or delayed baseline initialization.
- Validation: `npm run build` passed.
- 2026-02-13 blank-map render fallback fix:
  - Runtime tileset draw now validates atlas bounds (`atlasIndex < tilesetCellCount`) before drawing from tilesheet.
  - Added `tilesetRows` + `tilesetCellCount` tracking in runtime loader.
  - If atlas index is out of bounds, renderer now falls back to color tile rendering instead of silent no-op (blank tile).
- Validation: `npm run build` passed.
- 2026-02-13 baseline behavior correction:
  - Updated `ensureWorldBaselineForUser` to stop destructive map resets.
  - New behavior:
    - If user has no maps, seed blank `spawn`.
    - If user already has maps (including a created `spawn`), do not overwrite/delete them.
    - Still records baseline version in `user_world_state`.
  - This prevents game start/bootstrap from replacing user-authored maps with a fresh blank `spawn`.
- Validation: `npm run build` passed.
- 2026-02-13 runtime terrain visibility hardening:
  - Updated map render pipeline to always draw fallback tile color first, then overlay tileset atlas art.
  - This prevents full-map blank visuals when atlas cells are transparent or misaligned for saved custom tile IDs.
  - Combined with atlas bounds checks, map tile placement remains visible based on saved tile IDs/positions even when sprite-sheet sampling fails.
- Validation: `npm run build` passed.
- 2026-02-13 tileset persistence fix for runtime rendering:
  - Tiles tab file upload now converts selected tileset image to a persistent `data:` URL instead of temporary `blob:` URL.
  - Saved map/tileset data now keeps a runtime-loadable tileset URL across reloads/sessions.
  - Updated `loadExampleTileset` to report missing bundled example tileset instead of setting an invalid path.
- Validation: `npm run build` passed.
- 2026-02-13 DB tile-library source of truth:
  - `/api/content/bootstrap` now returns raw `savedPaintTiles` from tile library table.
  - `worldContentStore` now persists `savedPaintTiles` in local world-content cache.
  - Runtime now rebuilds custom tile definitions directly from `savedPaintTiles` (code + atlasIndex), then merges them into active tile definitions.
  - This makes map tile rendering explicitly sourced from saved tiles DB records.
- Validation: `npm run build` passed.
- 2026-02-13 DB schema mismatch fix for fallback-only terrain rendering:
  - Ran live Supabase SQL probes (via `DB_CONNECTION_STRING`) and confirmed:
    - `world_maps` has `spawn` for the active user with non-blank tile content (99 non-blank cells).
    - `tile_libraries.saved_tiles` has 47 tile stamps / 248 atlas cells.
    - all tile codes used in `spawn` exist in `saved_tiles` (0 missing codes).
    - `tile_libraries.tileset_config` stores dimensions as `tilePixelWidth/tilePixelHeight`.
  - Identified client/runtime mismatch: runtime expects `CustomTilesetConfig` as `tileWidth/tileHeight`, so atlas draw path never activated and map showed fallback colors only.
  - Patched `src/game/content/worldContentStore.ts`:
    - added `sanitizeCustomTilesetConfig(raw)` that accepts either shape (`tileWidth/tileHeight` or `tilePixelWidth/tilePixelHeight`) and normalizes to runtime shape.
    - applied sanitizer in both `readStoredWorldContent` and `hydrateWorldContentFromServer`.
- Validation: `npm run build` passed.
- 2026-02-13 layer overlay render fix:
  - Updated runtime terrain draw order in `src/game/engine/runtime.ts` so each cell now tries atlas draw first and only falls back to color when atlas draw fails.
  - This preserves transparency on higher layers, allowing lower-layer tiles to show through in the same cell.
- Validation: `npm run build` passed.
- 2026-02-13 runtime z-depth pass for actor vs overhead tiles:
  - Added a depth-sorted draw queue in `src/game/engine/runtime.ts` that combines actors and overhead tile overlays.
  - Overhead candidates: tiles on non-base layers (`layerIndex > 0`) or tiles with `height > 0`.
  - Sorting key uses `depthY` (tile/actor foot Y), so actor appears in front when lower on screen (higher y), and behind when above (lower y).
  - Tie-break keeps overlay before actor at equal Y, and lower layers before higher layers.
- Validation: `npm run build` passed.
- 2026-02-13 z-depth tuning fix (tree/building front-back inversion):
  - Updated runtime tile pass to avoid duplicate drawing of overhead tiles.
  - New behavior:
    - ground tiles (`layerIndex === 0` and `tile.height === 0`) draw in base pass,
    - overhead tiles (`layerIndex > 0` or `tile.height > 0`) draw only in depth queue.
  - Changed depth tie-break at equal Y so `actor` draws before `overlay`.
    - Result: actor in same cell as overhead tile appears behind it.
    - Actor in the cell below appears in front (higher Y wins).
- Validation: `npm run build` passed.
- 2026-02-13 UI tweak: removed the in-game Objective banner from `src/game/engine/GameView.tsx`.
- Validation: `npm run build` passed.
- 2026-02-13 gameplay-only HUD update + fixed camera viewport:
  - Removed top HUD bar (name/location/save/time) from `src/game/engine/GameView.tsx`.
  - Kept dialogue and pause menu overlays.
  - Set default render camera to fixed `19x15` tiles (`TILE_SIZE * 19` by `TILE_SIZE * 15`) in `GameView`.
  - Updated canvas resize behavior to keep fixed camera resolution and scale display in viewport.
  - Updated runtime camera centering in `src/game/engine/runtime.ts` so maps larger than the viewport keep the player centered (no edge clamp).
  - Updated `src/styles.css` viewport layout to center the scaled fixed-resolution canvas.
- Validation: `npm run build` passed.
- 2026-02-13 warp proximity popup:
  - Added runtime warp hint state (`warpHintLabel`) in `src/game/engine/runtime.ts`.
  - Added `updateWarpHint()` to detect nearby labeled warps and expose popup text when within 1 tile (including facing-tile checks for interact-only warps).
  - Added `warpHint` to `RuntimeSnapshot` and `render_game_to_text` payload.
  - Added UI overlay in `src/game/engine/GameView.tsx` to display warp label popup when near a warp.
  - Added `.warp-popup` styling in `src/styles.css`.
- Validation: `npm run build` passed.
- 2026-02-13 in-game menu expansion (Squad first pass):
  - Added side menu entries: `Collection (Soon)`, `Squad`, `Backpack (Soon)` in `src/game/engine/GameView.tsx`.
  - Added side-menu subview state (`root` / `squad`) and reset-to-root on menu close.
  - Implemented `Squad` panel UI with 8 pill slots in a 2x4 grid:
    - top row (2 slots) unlocked and shown as `Empty`,
    - remaining 6 slots shown as `Locked`.
  - Added new menu styles in `src/styles.css` for section/actions layout and squad pill grid.
- Validation: `npm run build` passed.
- 2026-02-14 map tweak: Updated `uncle-hank` NPC sprite in `src/game/data/maps/uncleSHouse.ts` from `ow3.png` to `ow7.png`.
- Validation: `npm run build` passed.
- 2026-02-14 runtime map hydration patch: added `ensureDefaultStoryNpcs` in `src/game/engine/runtime.ts` to inject `Uncle Hank` into `uncle-s-house` when DB/stored map content is missing him (prevents static-file vs DB map drift).
- Validation: `npm run build` passed.
- 2026-02-14 NPC/data reset + sprite animation extensibility:
  - Executed DB reset script using `DB_CONNECTION_STRING` to purge current NPC content:
    - `world_maps`: set `map_data.npcs = []` for all rows (`mapsUpdated: 4`).
    - `npc_libraries`: cleared `sprite_library` + `character_library` (`npcLibrariesCleared: 1`).
    - `player_sprite_configs`: deleted rows (`playerSpriteConfigsDeleted: 0`, none existed).
  - Removed all source-map NPC arrays from:
    - `src/game/data/maps/portlock.ts`
    - `src/game/data/maps/starterTown.ts`
    - `src/game/data/maps/rivalHouse.ts`
    - `src/game/data/maps/uncleSHouse.ts`
  - Removed runtime NPC auto-injection fallback in `src/game/engine/runtime.ts` so NPC population is fully data-driven.
  - Emptied default NPC sprite/character catalogs in `src/game/world/npcCatalog.ts` for a clean overhaul baseline.
  - Added extensible sprite animation schema support:
    - `NpcSpriteConfig.animationSets` (named directional frame sets)
    - `NpcSpriteConfig.defaultIdleAnimation` / `defaultMoveAnimation`
    - `NpcDefinition.idleAnimation` / `moveAnimation` (character-level animation selection)
    - Files updated: `src/game/world/types.ts`, `src/game/engine/runtime.ts`, `vite.config.ts`, `src/admin/mapEditorUtils.ts`, `src/admin/MapEditorTool.tsx`.
  - Updated player sprite workflow to emit named animation sets (`idle`, `walk`) while preserving existing frame fields:
    - `src/game/world/playerSprite.ts`
    - `src/admin/PlayerSpriteTool.tsx`
  - Bumped local NPC catalog IndexedDB keys to prevent stale local NPC catalogs from rehydrating server-cleared data:
    - `map-editor-npc-sprite-library-v3`
    - `map-editor-npc-character-library-v3`
- Validation:
  - `npm run build` passed after all changes.
  - Playwright smoke script reached auth screen only (no authenticated session in headless run), so gameplay-level visual verification requires signed-in test run.
- 2026-02-14 admin animation-authoring pass (multi-animation support):
  - Extended NPC Studio UI (`src/admin/MapEditorTool.tsx`) to support arbitrary named directional animation sets:
    - Added editable `Animation Sets JSON` field for sprite entries.
    - Added sprite defaults: `Default Idle Animation`, `Default Move Animation`.
    - Atlas assignment + 4x4 autofill now keep `idle`/`walk` sets synchronized inside the JSON draft while preserving extra custom sets.
    - Sprite save now validates JSON/default animation names before persisting.
  - Extended Character Template UI in NPC Studio:
    - Added per-character animation selectors: `Character Idle Animation`, `Character Move Animation`.
    - Character save validates selected animation names exist on the chosen sprite.
    - Template load/use now restores these animation names.
  - Extended Player Sprite admin tool (`src/admin/PlayerSpriteTool.tsx`) with the same animation-set workflow:
    - Added `Animation Sets JSON`, `Default Idle Animation`, and `Default Move Animation` controls.
    - Save endpoint payload now persists custom animation sets/default names (not just hardcoded idle/walk).
    - Atlas assignment + 4x4 autofill sync the `idle`/`walk` sets in draft JSON while preserving extras.
  - Added shared parsing/sanitization helpers in both admin tools for robust JSON handling and fallback generation from legacy `facingFrames`/`walkFrames`.
- Validation:
  - `npm run build` passed after UI + parser updates.

## 2026-02-14 (Admin Animation UI)
- Refactored NPC sprite animation editing in `/src/admin/MapEditorTool.tsx`:
  - Added list-based animation management (add, rename, delete animations).
  - Added per-direction frame management (add selected frame, remove frame, clear direction).
  - Removed user-facing animation JSON editing from NPC sprite workflow.
  - Kept file-based sheet loading flow and removed URL/example-button path from NPC studio UI.
  - Updated sprite "Use" action to restore animation data and auto-select a valid current animation.
  - Fixed save validation/status text and corrected JSX tag mismatches.
  - Added legacy `facingFrames`/`walkFrames` derivation from chosen default idle/move animations.
- Refactored player sprite animation editing in `/src/admin/PlayerSpriteTool.tsx`:
  - Removed URL/default-example editing controls from UI and kept file upload workflow.
  - Replaced idle/walk assign-mode controls with the same list-based animation editor used for NPC sprites.
  - Added frame removal controls and direction clearing.
  - Removed user-facing animation JSON textarea.
  - Save now validates default animation names against animation sets and derives legacy `facingFrames`/`walkFrames` from animation sets for compatibility.
- Validation:
  - `npm run build` passed.
  - Playwright admin smoke run succeeded technically, but UI verification was blocked by auth gate (`Sign In Required` page, 401 on admin data endpoint), so no authenticated admin screenshot was captured in this run.

### Follow-up
- After signing in, re-run the admin Playwright/screenshot pass to visually confirm the new animation controls in both Player Sprite and NPC Studio panels.
- 2026-02-14 player sprite persistence fix:
  - Diagnosed missing in-game sprite rendering as temporary `blob:` URLs being persisted for player sprites.
  - Updated `/src/admin/PlayerSpriteTool.tsx` file upload flow to convert selected images to persistent `data:` URLs before save.
  - Added server-side safety in `/vite.config.ts`:
    - reject saving `blob:` URLs in `/api/admin/player-sprite/save`.
    - sanitize loaded player sprite config (ignore blob-based rows) for both `/api/admin/player-sprite/get` and `/api/content/bootstrap`.
  - Replaced broken blob URL in `/src/game/world/playerSprite.ts` with stable project asset path `/example_assets/character_npc_spritesheets/main_character_spritesheet.png`.
  - Validation: `npm run build` passed.
- 2026-02-14 follow-up sprite rendering reliability fixes:
  - Added client-side player sprite config sanitizer in `src/game/content/worldContentStore.ts` to ignore stale/invalid `blob:` sprite URLs from local cache.
  - Added defensive `persistWorldContent` fallback: if localStorage quota write fails, retry without `playerSpriteConfig` so world content hydration still succeeds.
  - Updated NPC file upload in `src/admin/MapEditorTool.tsx` to use persistent data URLs (no temporary object URLs).
  - Validation: `npm run build` passed.
- 2026-02-14 NPC admin performance stabilization:
  - Added atlas preview cell cap (`MAX_ATLAS_PREVIEW_CELLS = 4096`) to NPC and player sprite editors to prevent rendering huge tens-of-thousands-cell grids that lock the UI.
  - NPC Studio now shows a warning when preview is truncated and advises increasing atlas cell size.
  - Removed duplicate NPC URL state assignment to reduce memory churn during sheet load.
- 2026-02-14 source bundle bloat fix:
  - Prevented `data:` player sprite URLs from being written into `src/game/world/playerSprite.ts` during save (DB keeps full URL; source file keeps stable fallback URL).
  - Restored `src/game/world/playerSprite.ts` URL to project asset path.
  - Validation: `npm run build` passed and bundle size returned to normal range.
- 2026-02-14 default sprite cell size update:
  - Set NPC atlas cell width/height admin defaults to `64x64` in `src/admin/MapEditorTool.tsx`.
  - Updated NPC sprite sanitize fallbacks to `64x64` when frame size fields are missing.
  - Updated player-sprite save API fallback frame width/height to `64x64` in `vite.config.ts`.
  - Validation: `npm run build` passed.
- 2026-02-14 animation add/save persistence fix:
  - Root cause: empty animations were being removed by animation-set sanitization, so newly added animations vanished from dropdowns.
  - Updated animation-set sanitization in both admin tools to preserve animation names even when direction frame arrays are empty.
  - Updated parse validation messaging to require at least one animation name (not at least one populated frame list).
  - Updated player-sprite backend parser in `vite.config.ts` to preserve empty animations/directions when saving to DB/source payload.
  - Result: new animations now appear immediately in dropdowns, remain selected for editing, and persist across save/load.
  - Validation: `npm run build` passed.
- 2026-02-14 Supabase spritesheet bucket integration:
  - Completed Supabase storage wiring in `vite.config.ts`:
    - `createAdminMapApiPlugin` now receives `SUPABASE_URL` + `SUPABASE_SERVICE_ROLE_KEY` config via `normalizeSupabaseStorageConfig(...)`.
    - Enabled authenticated `GET /api/admin/spritesheets/list` usage with bucket/prefix support for PNG discovery.
  - Added searchable Supabase spritesheet browsers in both admin sprite workflows:
    - `src/admin/PlayerSpriteTool.tsx`:
      - New Bucket/Prefix/Search controls.
      - Alphabetized scrollable list of PNG objects from Supabase.
      - One-click `Load` applies selected spritesheet public URL as active player sheet.
    - `src/admin/MapEditorTool.tsx` (NPC Studio):
      - Same Bucket/Prefix/Search + alphabetical scrollable list.
      - One-click `Load` applies selected spritesheet URL to NPC sheet and optionally seeds label from filename.
  - Added shared list styling in `src/styles.css` (`spritesheet-browser*` classes).
  - Validation:
    - `npm run build` passed.
    - Playwright smoke (`output/admin-supabase-picker/shot-0.png`) reached unauthenticated admin gate (`Sign In Required`), so logged-in picker UI verification is pending an authenticated run.
- 2026-02-14 NPC Studio UI cleanup:
  - Removed `Clear NPC Catalog` button from NPC Studio controls (`src/admin/MapEditorTool.tsx`).
  - Removed NPC `Auto Fill 4x4 D/L/R/U` button and related note text.
  - Sprite label behavior is now fully manual in NPC Studio:
    - no auto-label assignment from file upload,
    - no auto-label assignment from Supabase sheet selection,
    - added explicit note that sprite label saves exactly as entered.
  - Validation: `npm run build` passed.
- 2026-02-14 Supabase bucket connection fix:
  - Diagnosed empty picker root cause as bucket-name typo mismatch:
    - empty bucket checked by app default: `character-spirtesheets` (0 PNGs)
    - actual populated bucket: `character-spritesheets` (7 PNGs)
  - Updated default Supabase bucket fallback in:
    - `src/admin/PlayerSpriteTool.tsx`
    - `src/admin/MapEditorTool.tsx`
    - `vite.config.ts` (`sanitizeStorageBucketName` default)
  - Validation: `npm run build` passed.
